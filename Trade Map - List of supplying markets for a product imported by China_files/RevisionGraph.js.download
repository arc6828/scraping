function GraphChart(n,t){function d(t){function f(){this.byId={};this.byRevision={}}var r=d3.select("#"+n),i,u;return(r.selectAll("*").remove(),!t)?null:(i=new f,u=[],t.nodes.forEach(function(n){n.order=0;n.links=[];n.children=[];n.selected&&u.push(n.year);i.byId[n.id]=n;var t=i.byRevision[n.revision];t||(t=[],i.byRevision[n.revision]=t);t.push(n)}),t.links=t.links.map(function(n){return typeof n.source!="object"&&(n.source=i.byId[n.source],n.source.links||(n.source.links=[]),n.source.links.push(n)),typeof n.target!="object"&&(n.target=i.byId[n.target],n.target.links||(n.target.links=[]),n.target.links.push(n),n.source.children.push(n.target)),n}),{chartData:t,chartSankey:null,chartDiv:r,chartSvg:r.append("svg"),nodesMap:i,chartWidth:o,chartHeight:s,selectedRevisionsYears:u.sort(function(n,t){return n-t})})}function g(){var l=i.chartData,t=i.nodesMap,h,n;l.revisions.forEach(function(n){for(var i=t.byRevision[n.id],u,i=i.sort(function(n,t){return n.selected&&t.selected?0:n.selected?-1:1}),r=0;r<i.length;r++)u=i[r],u.order=r;t.byRevision[n.id]=i});h=0;n=0;l.revisions.forEach(function(i){for(var f,s=t.byRevision[i.id],o=0;o<s.length;o++)f=s[o],f.x=h*(r+c),f.y=f.order*(u+e),n=Math.max(f.y,n),ht(f);h++});i.chartWidth=o;i.chartHeight=Math.max(s,f+e+n+u+e)}function nt(){var n=i.chartSvg.append("g"),t=i.chartData,r;t&&t.revisions&&t.revisions.length!=0?(tt(n),it(n),rt(n)):ut(n);i.chartDiv.style({width:sprintf("%spx",i.chartWidth),height:sprintf("%spx",i.chartHeight)});i.chartSvg.attr({width:i.chartWidth,height:i.chartHeight});r=n.node().getBBox();n.attr({transform:function(){var n=Math.max((i.chartSvg.attr("width")-r.width)/2,0);return sprintf("translate(%s, %s)",n,0)}})}function tt(n){var t=n.append("g").selectAll(".nodes-header").data(i.chartData.revisions).enter().append("g").attr("class","nodes-header").attr("transform",function(n,t){var i=t*(r+c);return sprintf("translate(%s, %s)",i,0)});t.append("text").attr({"text-anchor":"middle",x:r/2,y:f/2+h}).text(function(n){return n.name})}function it(n){var t=i.nodesMap,r=n.append("g").attr("transform",function(){return sprintf("translate(%s, %s)",0,f+e)}).selectAll(".link").data(i.chartData.links).enter().append("path").attr("class","link").attr("id",function(n){return a(n)}).style("stroke",10).attr("d",function(n){return l(n)})}function rt(n){var t=n.append("g").attr("transform",function(){return sprintf("translate(%s, %s)",0,f+e)}).selectAll(".node").data(i.chartData.nodes).enter().append("g").classed("node",!0).attr({transform:function(n){return sprintf("translate(%(x)f, %(y)f)",n)}}).call(d3.behavior.drag().origin(function(n){return n}).on("dragstart",function(n){n.isDragging=!0}).on("drag",st).on("dragend",function(n){n.isDragging=!1})).on({mouseover:function(n){ft(n,this)},mouseout:function(n){et(n,this)},click:function(n){ot(n,this)}});t.append("rect").attr({rx:10,ry:10,width:r,height:u}).style({fill:function(n){return n.selected?k:b},"fill-opacity":function(n){var t=i.selectedRevisionsYears;return!n.selected||!t||t.length<=0?1:n.opacity}});t.append("text").attr({"text-anchor":"middle",x:function(){return r/2},y:function(){return u/2+p}}).text(function(n){return n.productCode})}function ut(n){var i=n.append("g").append("g").attr("class","nodes-header");i.append("text").attr({"text-anchor":"middle",x:r/2,y:f/2+h}).text(t.noDataLabel)}function ft(n,t){n.isModalDialogShown||n.isDragging||v(n,t,!1)}function et(n,t){n.isModalDialogShown||y(n,t)}function ot(n,t){v(n,t,!0)}function st(n){var t=d3.event;n&&t&&(t.sourceEvent.stopPropagation(),n.y+=t.dy,n.y=Math.max(0,n.y),n.y=Math.min(n.y,i.chartHeight-(f+u+e+w)),d3.select(this).attr("transform",function(){return sprintf("translate(%(x)f, %(y)f)",n)}),n.links&&n.links.forEach(function(n){d3.select("#"+a(n)).attr("d",function(){return l(n)})}))}function l(n){if(!n)return null;var t={sourceX:n.source.x+r,sourceY:n.source.y+u/2,sourceCubicX:(n.source.x+r+n.target.x)/2,sourceCubicY:n.source.y+u/2,targetX:n.target.x,targetY:n.target.y+u/2,targetCubicX:(n.source.x+r+n.target.x)/2,targetCubicY:n.target.y+u/2};return sprintf("M%(sourceX)f,%(sourceY)fC%(sourceCubicX)f,%(sourceCubicY)f,%(targetCubicX)f,%(targetCubicY)f,%(targetX)f,%(targetY)f",t)}function a(n){return"link-"+n.id}function v(n,i,r){var u,e,f;(n.dialog&&y(n,i),d3.event.defaultPrevented)||(u=$("#"+t.dialogElementId).clone(),u.find(".js-product-code-value").text(n.productCode),u.find(".js-revision-value").text(n.year),u.find(".js-label-value").text(n.label),u.appendTo("body"),n.dialog=u,n.isModalDialogShown=r,e={my:"left top",at:"left bottom",collision:"flip flip",of:i,using:function(n,t){var r=0,u=0,f,e;n.top<=0&&n.left<=0?(f=d3.select(i).node().getBoundingClientRect(),r=f.left,u=f.top+f.height+2,t.vertical!=="top"&&(u=u+document.body.scrollTop),t.horizontal!="left"?r=document.body.offsetWidth-document.body.scrollLeft-(r+t.element.width)<0?r+document.body.scrollLeft-(t.element.width-f.width):r+document.body.scrollLeft:document.body.offsetWidth-(r+t.element.width)<0&&(r=r-(t.element.width-f.width))):(e=d3.select(i).node().getBBox(),r=n.left,u=n.top+e.height+2,t.vertical!="top"&&(u=u-e.height-2),t.horizontal!="left"&&(r=r+e.width));$(this).css({left:r+"px",top:u+"px"})}},f={minWidth:500,position:e,modal:!1,dialogClass:r?"dialog-product-details":"dialog-product-details tooltip-product-details",close:function(){n.dialog.remove();n.dialog=null;n.isModalDialogShown=!1}},r&&(f.buttons=[{text:t.buttonViewHSLabel,click:function(){var i=t.onButtonViewHSClick;i&&i(n)}},{text:t.buttonTradeDataLabel,click:function(){var i=t.onButtonTradeDataClick;i&&i(n)}}]),u.dialog(f),r&&n.selected&&(RevisionGraphIsPopup===!0&&n.productCode===CurrentAppProductCode?u.siblings(".ui-dialog-buttonpane").hide():u.siblings(".ui-dialog-buttonpane").find("button").eq(0).hide()))}function y(n){n&&n.dialog&&n.dialog.dialog("close")}function ht(n){if(n.children){var t=i.nodesMap;n.children.forEach(function(i){if(i.productCode==n.productCode&&i.order!=n.order){var r=t.byRevision[i.revision];r.forEach(function(t){t.order==n.order&&(t.order=i.order)});i.order=n.order}})}}var o=975,s=400,f=40,h=5,c=100,r=100,u=40,e=50,p=5,w=2,b="white",k="green",i=null;t=$.extend(!0,{dialogElementId:"dialog-product-details",buttonViewHSLabel:"View revisions correspondences",buttonTradeDataLabel:"View trade data",onButtonViewHSClick:null,onButtonTradeDataClick:null},t||{});this.buildChart=function(n){try{if(i=d(n),!i)return;g();nt()}catch(t){console.log(t)}}}